<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns=""
        xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-3.xsd">
    <parameter name="workEffortId"/>
    <transition name="updateTask"><service-call name="wm.TaskServices.update#Task" in-map="context" out-map="context"/>
        <default-response type="none"/></transition>
    <transition name="addComment"><service-call name="wm.TaskServices.add#Comment"/>
        <default-response type="none"/>
    </transition>
    <transition name="deleteComment"><service-call name="mantle.work.TaskServices.delete#TaskComment"/>
        <default-response type="none"/>
    </transition>
    <transition-include name="getUserProjectList" location="component://SimpleScreens/template/work/WorkTransitions.xml"/>
    <subscreens>
        <subscreens-item name="TaskCommentUpdate" location="component://SimpleScreens/screen/SimpleScreens/Task/TaskSummary/TaskCommentUpdate.xml"/>
    </subscreens>
    <actions>
        <service-call name="wm.TaskServices.get#Task" out-map="context" in-map="context"/>
        <entity-find-one entity-name="mantle.work.effort.WorkEffort" value-field="workEffort"/>
        <!-- To support status change -->
        <set field="statusId" from="workEffort?.statusId"/>
        <set field="workEffortId" from="workEffort?.workEffortId"/>
        <set field="statusChangeTransition" value="updateTask"/>
        <!-- Assignee
        <entity-find-one entity-name="mantle.work.effort.WorkEffortParty" value-field="assignee">
            <field-map field-name="workEffortId" from="workEffortId"/>
            <field-map field-name="roleTypeId" value="Assignee"/>
        </entity-find-one>
        -->
        <!-- Get current assignee -->
        <entity-find entity-name="mantle.work.effort.WorkEffortParty" list="assignToList">
            <econdition field-name="workEffortId"/>
            <econdition field-name="roleTypeId" value="Assignee"/>
            <date-filter/>
        </entity-find>
        <!-- It is technically possible to have more than one, so just use the first record -->
        <if condition="assignToList">
            <set field="curAssignToPartyId" from="assignToList[0].partyId"/>
        </if>
        <!-- Comments -->
        <entity-find entity-name="mantle.work.effort.WorkEffortCommEventDetail" list="commEventDetailList">
            <econdition field-name="workEffortId"/><order-by field-name="entryDate"/></entity-find>
    </actions>
    <widgets>
        <label text="Select a task or create a new one" type="strong" condition="!workEffortId"/>
        <section name="TaskDetailSection" condition="workEffortId">
            <widgets>
        <container-box><box-header/>
            <box-body height="75vh">
                <form-single name="TaskDetailForm" transition="updateTask" map="workEffort" background-submit="true" background-reload-id="TaskDetailContainer">
                    <field name="workEffortId"><default-field><hidden/></default-field></field>
                    <field name="workEffortName"><default-field title="Task"><text-line size="40"/></default-field></field>
                    <field name="rootWorkEffortId"><default-field title="Project"><drop-down allow-empty="true">
                        <dynamic-options transition="getUserProjectList" server-search="true" min-length="0"/></drop-down></default-field></field>
                    <!-- Set new assignee to current so when the update service is called it can evaluate if the assignee changed -->
                    <field name="assignToPartyId" from="curAssignToPartyId"><default-field title="Assigned To">
                        <drop-down allow-empty="true"><entity-options text="PartyNameOnlyTemplate">
                            <entity-find entity-name="mantle.party.PersonWithUserAccount">
                                <order-by field-name="lastName"/>
                            </entity-find>
                        </entity-options></drop-down></default-field>
                    </field>
                    <field name="estimatedCompletionDate"><default-field title="Due Date"><date-time type="date" format="yyyy-MM-dd"/></default-field></field>
                    <field name="statusId"><default-field title="Status">
                        <widget-template-include location="component://webroot/template/screen/BasicWidgetTemplates.xml#statusTransitionWithFlowDropDown">
                            <set field="currentDescription" from="workEffort?.'WorkEffort#moqui.basic.StatusItem'?.description"/>
                            <set field="statusId" from="workEffort?.statusId"/></widget-template-include>
                    </default-field></field>
                    <field name="description"><default-field title="Description"><text-area editor-type="ckhtml" rows="10" cols="60"/></default-field></field>
                    <field name="submitButton"><default-field title="Update"><submit/></default-field></field>
                    <!-- Not necessary unless more fields are added in the future and need to be aligned in the same row. -->
                    <field-layout>
                        <field-col-row>
                            <field-col lg="6"><field-ref name="workEffortName"/></field-col>
                            <field-col lg="6"><field-ref name="rootWorkEffortId"/></field-col>
                        </field-col-row>
                        <field-col-row>
                            <field-col lg="5"><field-ref name="assignToPartyId"/></field-col>
                            <field-col lg="4"><field-ref name="statusId"/></field-col>
                            <field-col lg="3"><field-ref name="estimatedCompletionDate"/></field-col>
                        </field-col-row>
                        <field-ref name="description"/>
                        <field-ref name="submitButton"/>
                        <!--
                        <field-row-big><field-ref name="workEffortName"/></field-row-big>
                        <field-row-big><field-ref name="estimatedCompletionDate"/></field-row-big>
                        <field-row-big><field-ref name="description"/></field-row-big>
                        <field-row-big><field-ref name="submitButton"/></field-row-big>
                        -->
                    </field-layout>

                </form-single>
        <container-box><box-header title="Comments"/>
            <box-toolbar>
                <container-dialog id="AddCommentDialog" button-text="Add Comment">
                    <form-single name="AddCommentForm" transition="addComment" background-submit="true" background-reload-id="TaskDetailContainer">
                        <field name="workEffortId"><default-field><hidden/></default-field></field>
                        <field name="body"><default-field title="Comment"><text-area editor-type="ckhtml" rows="10"/></default-field></field>
                        <field name="submitButton"><default-field title="Add"><submit/></default-field></field>
                    </form-single>
                </container-dialog>
            </box-toolbar>
            <box-body>
                <section-iterate name="CommentList" list="commEventDetailList" entry="commEventDetail">
                    <actions>
                        <set field="uniqueExtension" from="commEventDetail_index"/>
                        <entity-find-one entity-name="mantle.party.Person" value-field="fromPerson" cache="true">
                            <field-map field-name="partyId" from="commEventDetail.fromPartyId"/>
                        </entity-find-one>
                    </actions>
                    <widgets><container-box>
                        <box-header title="${fromPerson ? fromPerson.firstName + ' ' + fromPerson?.lastName : 'Unknown'} ${ec.l10n.format(commEventDetail.entryDate, 'yyyy-MM-dd HH:mm')}"/>
                        <box-toolbar>
                            <dynamic-dialog id="EditCommentContainer${uniqueExtension}" button-text="Edit" transition="TaskCommentUpdate" condition="commEventDetail.fromPartyId == ec.user.userAccount.partyId">
                                <parameter name="communicationEventId" from="commEventDetail.communicationEventId"/></dynamic-dialog>
                            <link text="Delete" dynamic-load-id="TaskDetailContainer" url="deleteComment" parameter-map="[workEffortId:workEffortId,
                                        communicationEventId:commEventDetail.communicationEventId]" condition="commEventDetail.fromPartyId == ec.user.userAccount.partyId"
                                  confirmation="Delete comment?"/>
                        </box-toolbar>
                        <box-body>
                            <label text="${commEventDetail.body}" encode="false" condition="commEventDetail?.body"/>
                        </box-body>
                    </container-box>
                </widgets></section-iterate>
            </box-body></container-box></box-body></container-box>
            </widgets>
        </section>
    </widgets>
</screen>